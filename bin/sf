#!/usr/bin/env zsh
set -euo pipefail
setopt nullglob

# ============================================================
# sf ‚Äî Startup Factory CLI
# Manage startup factory projects
# ============================================================

VERSION="0.1.0"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

SCRIPT_DIR="${0:a:h}"

usage() {
  echo -e "${BOLD}sf${NC} ‚Äî Startup Factory CLI v${VERSION}"
  echo ""
  echo -e "${BOLD}USAGE${NC}"
  echo "  sf <command> [options]"
  echo ""
  echo -e "${BOLD}COMMANDS${NC}"
  echo "  init <idea>         Initialize a new startup project"
  echo "  run [dir]           Start/resume the agent pipeline"
  echo "  dashboard [dir]     Open the visual management dashboard"
  echo "  status [dir]        Show project status and phase progress"
  echo "  approve [dir]       Approve current phase gate and advance"
  echo "  pivot [dir]         Mark current phase for pivot/redo"
  echo "  list                List all startup projects"
  echo "  agents [dir]        Show agent roster and health"
  echo "  outputs [dir]       List all generated artifacts"
  echo "  log [dir]           Show recent agent activity"
  echo ""
  echo -e "${BOLD}OPTIONS${NC}"
  echo "  -d, --dir DIR       Project directory (default: current dir or ~/startups)"
  echo "  -h, --help          Show this help"
  echo "  -v, --version       Show version"
  echo ""
  echo -e "${BOLD}EXAMPLES${NC}"
  echo "  sf init \"AI pet nutrition advisor\""
  echo "  sf status ~/startups/pet-nutrition"
  echo "  sf approve"
  echo "  sf list"
}

# Resolve project directory
resolve_project() {
  local dir="${1:-}"
  
  # If explicit dir provided, use it
  if [[ -n "$dir" && -f "$dir/STARTUP.md" ]]; then
    echo "$dir"
    return 0
  fi
  
  # Check current directory
  if [[ -f "./STARTUP.md" ]]; then
    echo "$(pwd)"
    return 0
  fi
  
  # Check if explicit dir is a project name under ~/startups
  if [[ -n "$dir" && -f "${HOME}/startups/$dir/STARTUP.md" ]]; then
    echo "${HOME}/startups/$dir"
    return 0
  fi
  
  echo ""
  return 1
}

# ============================================================
# COMMANDS
# ============================================================

cmd_init() {
  exec "$SCRIPT_DIR/sf-init.sh" "$@"
}

cmd_status() {
  local project_dir
  project_dir=$(resolve_project "${1:-}") || {
    echo -e "${RED}Error: Not in a startup factory project. Specify a directory or cd into one.${NC}"
    exit 1
  }
  
  echo -e "${CYAN}${BOLD}üè≠ Startup Factory ‚Äî Project Status${NC}"
  echo ""
  
  # Read project info from STARTUP.md
  local idea phase
  idea=$(grep "^## Idea" "$project_dir/STARTUP.md" -A1 | tail -1)
  phase=$(grep "^- \*\*Phase:\*\*" "$project_dir/STARTUP.md" | sed 's/.*\*\*Phase:\*\* //')
  
  echo -e "  ${BOLD}Project:${NC}  $(basename "$project_dir")"
  echo -e "  ${BOLD}Idea:${NC}     $idea"
  echo -e "  ${BOLD}Phase:${NC}    $phase"
  echo -e "  ${BOLD}Location:${NC} $project_dir"
  echo ""
  
  # Show phase progress table
  echo -e "${BOLD}Phase Progress:${NC}"
  grep "^|" "$project_dir/STARTUP.md" 2>/dev/null | head -10
  echo ""
  
  # Count outputs
  local research_count product_count design_count code_count marketing_count ops_count
  research_count=$(find "$project_dir/outputs/research" -type f 2>/dev/null | wc -l | tr -d ' ')
  product_count=$(find "$project_dir/outputs/product" -type f 2>/dev/null | wc -l | tr -d ' ')
  design_count=$(find "$project_dir/outputs/design" -type f 2>/dev/null | wc -l | tr -d ' ')
  code_count=$(find "$project_dir/outputs/code" -type f 2>/dev/null | wc -l | tr -d ' ')
  marketing_count=$(find "$project_dir/outputs/marketing" -type f 2>/dev/null | wc -l | tr -d ' ')
  ops_count=$(find "$project_dir/outputs/ops" -type f 2>/dev/null | wc -l | tr -d ' ')
  
  echo -e "${BOLD}Artifacts:${NC}"
  echo "  üìä Research:  $research_count files"
  echo "  üìã Product:   $product_count files"
  echo "  üé® Design:    $design_count files"
  echo "  üíª Code:      $code_count files"
  echo "  üì£ Marketing: $marketing_count files"
  echo "  üí∞ Ops:       $ops_count files"
  echo ""
  
  # Show recent memory entries
  local -a mem_files
  mem_files=("$project_dir"/memory/*.md(N))
  if (( ${#mem_files} > 0 )); then
    echo -e "${BOLD}Recent Activity:${NC}"
    for f in ${(On)mem_files[1,3]}; do
      echo "  $(basename "$f")"
    done
    echo ""
  fi
}

cmd_approve() {
  local project_dir
  project_dir=$(resolve_project "${1:-}") || {
    echo -e "${RED}Error: Not in a startup factory project.${NC}"
    exit 1
  }
  
  local phase
  phase=$(grep "^- \*\*Phase:\*\*" "$project_dir/STARTUP.md" | sed 's/.*\*\*Phase:\*\* //')
  
  echo -e "${GREEN}${BOLD}‚úÖ Approving phase gate: $phase${NC}"
  echo ""
  
  local date_now
  date_now=$(date '+%Y-%m-%d %H:%M')
  
  # Update the current phase's approval in STARTUP.md
  # Mark current üîÑ as ‚úÖ, mark next ‚è∏Ô∏è as üîÑ
  sed -i '' "s/| üîÑ In Progress/| ‚úÖ Complete/g" "$project_dir/STARTUP.md"
  
  # Log the decision
  echo "- [$date_now] **APPROVED:** Phase gate for $phase" >> "$project_dir/STARTUP.md"
  
  echo -e "Phase ${BOLD}$phase${NC} approved at $date_now"
  echo -e "The CEO agent will advance to the next phase on its next heartbeat."
  echo ""
  echo -e "${DIM}Tip: Send a message to the CEO agent to advance immediately:${NC}"
  echo "  openclaw agent --workspace $project_dir --message \"Phase approved. Advance to next phase.\""
}

cmd_list() {
  local startups_dir="${HOME}/startups"
  
  if [[ ! -d "$startups_dir" ]]; then
    echo -e "${YELLOW}No startups found in ~/startups/${NC}"
    echo "Create one with: sf init \"Your idea here\""
    return
  fi
  
  echo -e "${CYAN}${BOLD}üè≠ Startup Factory ‚Äî All Projects${NC}"
  echo ""
  
  local count=0
  for dir in "$startups_dir"/*/; do
    if [[ -f "$dir/STARTUP.md" ]]; then
      count=$((count + 1))
      local name phase idea
      name=$(basename "$dir")
      phase=$(grep "^- \*\*Phase:\*\*" "$dir/STARTUP.md" 2>/dev/null | sed 's/.*\*\*Phase:\*\* //' || echo "Unknown")
      idea=$(grep "^## Idea" "$dir/STARTUP.md" -A1 2>/dev/null | tail -1 || echo "")
      
      echo -e "  ${BOLD}$name${NC}"
      echo -e "    Phase: $phase"
      echo -e "    Idea:  ${DIM}$idea${NC}"
      echo ""
    fi
  done
  
  if [[ $count -eq 0 ]]; then
    echo -e "  ${DIM}No projects found.${NC}"
    echo "  Create one with: sf init \"Your idea here\""
  else
    echo -e "  ${DIM}$count project(s) found.${NC}"
  fi
}

cmd_agents() {
  local project_dir
  project_dir=$(resolve_project "${1:-}") || {
    echo -e "${RED}Error: Not in a startup factory project.${NC}"
    exit 1
  }
  
  echo -e "${CYAN}${BOLD}üè≠ Agent Roster${NC}"
  echo ""
  
  _show_agent() {
    local id=$1 emoji=$2 role=$3
    local workspace="$project_dir/agents/$id"
    [[ "$id" == "ceo" ]] && workspace="$project_dir"
    local memory_count
    memory_count=$(wc -l < "$workspace/MEMORY.md" 2>/dev/null | tr -d ' ' || echo "0")
    printf "  %s ${BOLD}%s${NC} ‚Äî %s\n" "$emoji" "$id" "$role"
    printf "     Workspace: %s\n" "$workspace"
    printf "     Memory: %s lines\n\n" "$memory_count"
  }
  
  _show_agent "ceo"       "CEO"  "Orchestrator"
  _show_agent "scout"     "SCT"  "Market Research"
  _show_agent "pm"        "PM"   "Product Management"
  _show_agent "design"    "DSN"  "UI/UX Design"
  _show_agent "engineer"  "ENG"  "Full-Stack Engineering"
  _show_agent "marketing" "MKT"  "Growth & GTM"
  _show_agent "ops"       "OPS"  "Finance & Operations"
}

cmd_outputs() {
  local project_dir
  project_dir=$(resolve_project "${1:-}") || {
    echo -e "${RED}Error: Not in a startup factory project.${NC}"
    exit 1
  }
  
  echo -e "${CYAN}${BOLD}üè≠ Generated Artifacts${NC}"
  echo ""
  
  local phases=("research:üî¨" "product:üìã" "design:üé®" "code:üë®‚Äçüíª" "marketing:üì£" "ops:üí∞")
  
  for entry in "${phases[@]}"; do
    local phase emoji
    phase="${entry%%:*}"
    emoji="${entry#*:}"
    
    local dir="$project_dir/outputs/$phase"
    if [[ -d "$dir" ]]; then
      local files
      files=$(find "$dir" -type f -name "*.md" -o -name "*.html" -o -name "*.js" -o -name "*.css" -o -name "*.json" 2>/dev/null)
      if [[ -n "$files" ]]; then
        echo -e "  $emoji ${BOLD}$phase${NC}"
        echo "$files" | while read -r f; do
          echo "     $(echo "$f" | sed "s|$dir/||")"
        done
        echo ""
      fi
    fi
  done
}

cmd_dashboard() {
  local project_dir
  project_dir=$(resolve_project "${1:-}") || {
    echo -e "${RED}Error: Not in a startup factory project.${NC}"
    exit 1
  }
  
  local dashboard_file="$project_dir/dashboard/index.html"
  if [[ ! -f "$dashboard_file" ]]; then
    echo -e "${RED}Error: Dashboard not found at $dashboard_file${NC}"
    exit 1
  fi
  
  # Generate state.json for the dashboard to consume
  _generate_dashboard_state "$project_dir"
  
  echo -e "${CYAN}${BOLD}üè≠ Opening Dashboard${NC}"
  echo ""
  
  # Try to serve via a simple HTTP server for proper fetch() support
  local port=3456
  if command -v python3 >/dev/null 2>&1; then
    echo -e "  Serving dashboard at ${BOLD}http://localhost:${port}${NC}"
    echo -e "  ${DIM}Press Ctrl+C to stop${NC}"
    echo ""
    (cd "$project_dir/dashboard" && python3 -m http.server $port) &
    local server_pid=$!
    sleep 0.5
    open "http://localhost:${port}" 2>/dev/null || echo "  Open http://localhost:${port} in your browser"
    wait $server_pid 2>/dev/null
  else
    # Fallback: just open the file directly
    open "$dashboard_file" 2>/dev/null || xdg-open "$dashboard_file" 2>/dev/null || {
      echo -e "  Open this file in your browser:"
      echo "  file://$dashboard_file"
    }
  fi
}

_generate_dashboard_state() {
  local project_dir="$1"
  
  # Count artifacts per category
  local r p d c m o
  r=$(find "$project_dir/outputs/research" -type f 2>/dev/null | wc -l | tr -d ' ')
  p=$(find "$project_dir/outputs/product" -type f 2>/dev/null | wc -l | tr -d ' ')
  d=$(find "$project_dir/outputs/design" -type f 2>/dev/null | wc -l | tr -d ' ')
  c=$(find "$project_dir/outputs/code" -type f 2>/dev/null | wc -l | tr -d ' ')
  m=$(find "$project_dir/outputs/marketing" -type f 2>/dev/null | wc -l | tr -d ' ')
  o=$(find "$project_dir/outputs/ops" -type f 2>/dev/null | wc -l | tr -d ' ')
  
  # Determine current phase from STARTUP.md
  local current_phase=1
  local phase_num=0
  while IFS= read -r line; do
    if [[ "$line" == *"üîÑ In Progress"* ]]; then
      phase_num=$(echo "$line" | grep -o '[0-9]\.' | head -1 | tr -d '.')
      [[ -n "$phase_num" ]] && current_phase=$phase_num
    fi
  done < "$project_dir/STARTUP.md"
  
  # Build phase status map
  local phase_json="{"
  for i in 1 2 3 4 5 6 7; do
    local status="waiting"
    grep -q "$i\..*üîÑ In Progress" "$project_dir/STARTUP.md" 2>/dev/null && status="in-progress"
    grep -q "$i\..*‚úÖ Complete" "$project_dir/STARTUP.md" 2>/dev/null && status="complete"
    [[ $i -gt 1 ]] && phase_json+=","
    phase_json+="\"$i\":{\"status\":\"$status\"}"
  done
  phase_json+="}"
  
  # Get project info
  local idea name start_date
  idea=$(grep "^## Idea" "$project_dir/STARTUP.md" -A1 2>/dev/null | tail -1)
  name=$(basename "$project_dir")
  start_date=$(grep "^\- \*\*Started:\*\*" "$project_dir/STARTUP.md" 2>/dev/null | sed 's/.*\*\*Started:\*\* //' || date +%Y-%m-%d)
  
  cat > "$project_dir/dashboard/state.json" <<ENDJSON
{
  "projectName": "$name",
  "idea": "$idea",
  "startDate": "$start_date",
  "currentPhase": $current_phase,
  "phases": $phase_json,
  "artifacts": {
    "research": $r,
    "product": $p,
    "design": $d,
    "code": $c,
    "marketing": $m,
    "ops": $o
  }
}
ENDJSON
}

cmd_run() {
  local project_dir
  project_dir=$(resolve_project "${1:-}") || {
    echo -e "${RED}Error: Not in a startup factory project.${NC}"
    exit 1
  }
  
  local idea
  idea=$(grep "^## Idea" "$project_dir/STARTUP.md" -A1 | tail -1)
  local phase
  phase=$(grep "^- \*\*Phase:\*\*" "$project_dir/STARTUP.md" | sed 's/.*\*\*Phase:\*\* //')
  
  echo -e "${CYAN}${BOLD}üè≠ Starting Startup Factory${NC}"
  echo ""
  echo -e "  ${BOLD}Project:${NC} $(basename "$project_dir")"
  echo -e "  ${BOLD}Phase:${NC}   $phase"
  echo -e "  ${BOLD}Idea:${NC}    $idea"
  echo ""
  
  # Check if ClawRouter is available
  if curl -sf http://localhost:8402/health >/dev/null 2>&1; then
    echo -e "  ${GREEN}‚úì${NC} ClawRouter running"
  else
    echo -e "  ${YELLOW}‚ö†${NC} ClawRouter not detected (will use configured model fallback)"
  fi
  
  # Check if OpenClaw gateway is running
  if openclaw status >/dev/null 2>&1; then
    echo -e "  ${GREEN}‚úì${NC} OpenClaw Gateway running"
  else
    echo -e "  ${RED}‚úó${NC} OpenClaw Gateway not running ‚Äî start with: openclaw gateway start"
    exit 1
  fi
  
  echo ""
  echo -e "${BLUE}Launching CEO agent...${NC}"
  echo ""
  
  # Send the kickoff message to the CEO agent
  openclaw agent --workspace "$project_dir" \
    --message "Begin Phase 1: Discovery. The startup idea is: $idea. Follow BOOTSTRAP.md to get started."
}

cmd_log() {
  local project_dir
  project_dir=$(resolve_project "${1:-}") || {
    echo -e "${RED}Error: Not in a startup factory project.${NC}"
    exit 1
  }
  
  echo -e "${CYAN}${BOLD}üè≠ Recent Activity${NC}"
  echo ""
  
  # Show recent git commits
  (cd "$project_dir" && git log --oneline -10 2>/dev/null) || echo "  No git history."
  echo ""
  
  # Show recent memory files
  local recent
  recent=$(ls -t "$project_dir/memory/"*.md 2>/dev/null | head -5)
  if [[ -n "$recent" ]]; then
    echo -e "${BOLD}Recent Memory:${NC}"
    for f in $recent; do
      echo "  $(basename "$f") ‚Äî $(head -1 "$f")"
    done
  fi
}

# ============================================================
# DISPATCH
# ============================================================

case "${1:-help}" in
  init)
    shift
    cmd_init "$@"
    ;;
  status)
    shift
    cmd_status "$@"
    ;;
  approve)
    shift
    cmd_approve "$@"
    ;;
  list)
    cmd_list
    ;;
  agents)
    shift
    cmd_agents "$@"
    ;;
  outputs)
    shift
    cmd_outputs "$@"
    ;;
  log)
    shift
    cmd_log "$@"
    ;;
  run)
    shift
    cmd_run "$@"
    ;;
  dashboard)
    shift
    cmd_dashboard "$@"
    ;;
  pivot)
    shift
    echo -e "${YELLOW}Pivot support coming in v0.2. For now, edit STARTUP.md manually.${NC}"
    ;;
  -v|--version)
    echo "sf v${VERSION}"
    ;;
  -h|--help|help)
    usage
    ;;
  *)
    echo -e "${RED}Unknown command: $1${NC}"
    echo ""
    usage
    exit 1
    ;;
esac
